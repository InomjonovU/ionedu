{% extends 'teacher/base.html' %}

{% block page_title %}O'quvchilar{% endblock %}
{% block page_subtitle %}Barcha o'quvchilaringizni ko'ring{% endblock %}

{% block content %}
<style>
    .page-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .filters {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        flex: 1;
    }

    .filter-select {
        padding: 0.625rem 1.25rem;
        border: 2px solid #e2e8f0;
        background: white;
        border-radius: 10px;
        font-size: 0.875rem;
        font-weight: 500;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 200px;
    }

    .filter-select:focus {
        outline: none;
        border-color: #26CCC2;
    }

    .search-box {
        position: relative;
        flex: 1;
        max-width: 320px;
    }

    .search-box input {
        width: 100%;
        padding: 0.625rem 1rem 0.625rem 2.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .search-box input:focus {
        outline: none;
        border-color: #26CCC2;
    }

    .search-box svg {
        position: absolute;
        left: 0.875rem;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        color: #94a3b8;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-box {
        background: white;
        padding: 1.25rem;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #26CCC2;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #64748b;
    }

    .table-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
    }

    .data-table th {
        padding: 1rem 1.5rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .data-table td {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #f1f5f9;
        color: #1a202c;
        font-size: 0.875rem;
    }

    .data-table tbody tr {
        transition: background 0.2s;
    }

    .data-table tbody tr:hover {
        background: #f8fafc;
    }

    .student-cell {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .student-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #26CCC2 0%, #22b3aa 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .student-info {
        min-width: 0;
    }

    .student-name {
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 0.25rem;
    }

    .student-email {
        font-size: 0.75rem;
        color: #64748b;
    }

    .level-badge {
        padding: 0.375rem 0.875rem;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }

    .level-badge.beginner {
        background: #dbeafe;
        color: #1e40af;
    }

    .level-badge.junior {
        background: #d1fae5;
        color: #065f46;
    }

    .level-badge.middle {
        background: #fef3c7;
        color: #92400e;
    }

    .level-badge.senior {
        background: #e9d5ff;
        color: #6b21a8;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #f1f5f9;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #26CCC2 0%, #22b3aa 100%);
        border-radius: 4px;
        transition: width 0.3s;
    }

    .remove-btn {
        padding: 0.5rem 1rem;
        background: transparent;
        border: 2px solid #fee2e2;
        color: #dc2626;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .remove-btn:hover {
        background: #fee2e2;
        border-color: #dc2626;
    }

    .remove-btn svg {
        width: 14px;
        height: 14px;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .empty-state svg {
        width: 80px;
        height: 80px;
        color: #cbd5e1;
        margin-bottom: 1.5rem;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        color: #1a202c;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #64748b;
    }

    @media (max-width: 768px) {
        .page-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .filters {
            width: 100%;
        }

        .filter-select {
            min-width: 100%;
        }

        .search-box {
            max-width: 100%;
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            min-width: 900px;
        }
    }
</style>

<div class="page-header">
    <h1 class="page-title">O'quvchilar</h1>
    <p class="page-subtitle">Barcha o'quvchilaringizni ko'ring</p>
</div>

<!-- Statistics -->
<div class="stats-row">
    <div class="stat-box">
        <div class="stat-value">{{ total_students|default:0 }}</div>
        <div class="stat-label">Jami O'quvchilar</div>
    </div>
    <div class="stat-box">
        <div class="stat-value">{{ active_students|default:0 }}</div>
        <div class="stat-label">Faol O'quvchilar</div>
    </div>
    <div class="stat-box">
        <div class="stat-value">{{ avg_progress|default:0 }}%</div>
        <div class="stat-label">O'rtacha Progress</div>
    </div>
</div>

<!-- Page Actions -->
<div class="page-actions">
    <div class="filters">
        <select class="filter-select" id="courseFilter">
            <option value="all">Barcha Kurslar</option>
            {% for course in courses %}
            <option value="{{ course.id }}">{{ course.title }}</option>
            {% endfor %}
        </select>

        <select class="filter-select" id="levelFilter">
            <option value="all">Barcha Darajalar</option>
            <option value="beginner">Beginner</option>
            <option value="junior">Junior</option>
            <option value="middle">Middle</option>
            <option value="senior">Senior</option>
        </select>
    </div>

    <div class="search-box">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <input type="text" id="searchInput" placeholder="O'quvchi qidirish...">
    </div>
</div>

<!-- Table Container -->
<div class="table-container">
    {% if students %}
    <table class="data-table">
        <thead>
            <tr>
                <th>O'quvchi</th>
                <th>Kurs</th>
                <th>Daraja</th>
                <th>Yulduzlar</th>
                <th>Tangalar</th>
                <th>Progress</th>
                <th>Qo'shilgan</th>
                <th>Amal</th>
            </tr>
        </thead>
        <tbody id="studentTableBody">
            {% for enrollment in students %}
            <tr data-course="{{ enrollment.course.id }}" data-level="{{ enrollment.user.level }}">
                <td>
                    <div class="student-cell">
                        <div class="student-avatar">
                            {{ enrollment.user.first_name.0|default:enrollment.user.username.0 }}{{ enrollment.user.last_name.0|default:"" }}
                        </div>
                        <div class="student-info">
                            <div class="student-name">
                                {{ enrollment.user.get_full_name|default:enrollment.user.username }}
                            </div>
                            <div class="student-email">{{ enrollment.user.email }}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <strong>{{ enrollment.course.title }}</strong>
                </td>
                <td>
                    <span class="level-badge {{ enrollment.user.level }}">
                        {{ enrollment.user.get_level_display }}
                    </span>
                </td>
                <td>
                    <strong style="color: #fbbf24;">‚≠ê {{ enrollment.user.stars }}</strong>
                </td>
                <td>
                    <strong style="color: #26CCC2;">ü™ô {{ enrollment.user.coins }}</strong>
                </td>
                <td>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ enrollment.progress|default:0 }}%"></div>
                    </div>
                    <small style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                        {{ enrollment.progress|default:0 }}%
                    </small>
                </td>
                <td>
                    {{ enrollment.enrolled_at|date:"d.m.Y" }}
                </td>
                <td>
                    <button class="remove-btn" onclick="removeStudent({{ enrollment.id }}, '{{ enrollment.user.get_full_name|default:enrollment.user.username|escapejs }}', '{{ enrollment.course.title|escapejs }}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Chiqarish
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
        <h3>Hozircha o'quvchilar yo'q</h3>
        <p>Kurslaringizga o'quvchilar qo'shilishini kuting</p>
    </div>
    {% endif %}
</div>

<script>
    // Filter by course
    const courseFilter = document.getElementById('courseFilter');
    const levelFilter = document.getElementById('levelFilter');
    const searchInput = document.getElementById('searchInput');
    const tableRows = document.querySelectorAll('#studentTableBody tr');

    function applyFilters() {
        const courseValue = courseFilter.value;
        const levelValue = levelFilter.value;
        const searchTerm = searchInput.value.toLowerCase();

        tableRows.forEach(row => {
            const courseId = row.dataset.course;
            const level = row.dataset.level;
            const studentName = row.querySelector('.student-name').textContent.toLowerCase();
            const studentEmail = row.querySelector('.student-email').textContent.toLowerCase();

            let show = true;

            // Course filter
            if (courseValue !== 'all' && courseId !== courseValue) {
                show = false;
            }

            // Level filter
            if (levelValue !== 'all' && level !== levelValue) {
                show = false;
            }

            // Search filter
            if (searchTerm && !studentName.includes(searchTerm) && !studentEmail.includes(searchTerm)) {
                show = false;
            }

            row.style.display = show ? '' : 'none';
        });
    }

    courseFilter.addEventListener('change', applyFilters);
    levelFilter.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);

    // Remove student function
    function removeStudent(enrollmentId, studentName, courseName) {
        if (confirm(`${studentName}ni "${courseName}" kursidan chiqarishni xohlaysizmi?`)) {
            fetch(`/students/${enrollmentId}/remove/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Xatolik yuz berdi. Qayta urinib ko\'ring.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Xatolik yuz berdi. Qayta urinib ko\'ring.');
            });
        }
    }
</script>

{% endblock %}